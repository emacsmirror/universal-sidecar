image: nixos/unstable
packages:
  - nixos.emacs
  - nixos.hut
  - nixos.python3
sources:
  - https://github.com/riscy/melpazoid
tasks:
  - setup: |
      cd emacs-universal-sidecar
      emacs --batch -l build/init.el -f build/package-install-prereqs
  - lint-all: |
      cd emacs-universal-sidecar
      emacs --batch -l build/init.el -f package-lint-batch-and-exit *.el || exit 0
  - melpazoid: |
      cd melpazoid
      export LOCAL_REPO='~/emacs-universal-sidecar/'
      RECIPE=$(cat ~/emacs-universal-sidecar/build/recipes/universal-sidecar) \
          emacs --batch -l ~/emacs-universal-sidecar/build/init.el -l melpazoid/melpazoid.el
      RECIPE=$(cat ~/emacs-universal-sidecar/build/recipes/universal-sidecar-elfeed-related) \
          emacs --batch -l ~/emacs-universal-sidecar/build/init.el -l melpazoid/melpazoid.el
      RECIPE=$(cat ~/emacs-universal-sidecar/build/recipes/universal-sidecar-elfeed-score) \
          emacs --batch -l ~/emacs-universal-sidecar/build/init.el -l melpazoid/melpazoid.el
      RECIPE=$(cat ~/emacs-universal-sidecar/build/recipes/universal-sidecar-roam) \
          emacs --batch -l ~/emacs-universal-sidecar/build/init.el -l melpazoid/melpazoid.el
      RECIPE=$(cat ~/emacs-universal-sidecar/build/recipes/ebib-sidecar) \
          emacs --batch -l ~/emacs-universal-sidecar/build/init.el -l melpazoid/melpazoid.el
      RECIPE=$(cat ~/emacs-universal-sidecar/build/recipes/org-cite-sidecar) \
          emacs --batch -l ~/emacs-universal-sidecar/build/init.el -l melpazoid/melpazoid.el
  - build-main: |
      cd emacs-universal-sidecar
      emacs --batch -l build/init.el -L . -f batch-byte-compile \
          universal-sidecar.el universal-sidecar-sections.el
  - build-roam-sidecar: |
      cd emacs-universal-sidecar
      emacs --batch -l build/init.el -L . -f batch-byte-compile universal-sidecar-roam.el
  - build-elfeed-score-sidecar: |
      cd emacs-universal-sidecar
      emacs --batch -l build/init.el -L . -f batch-byte-compile universal-sidecar-elfeed-score.el
  - build-elfeed-related-sidecar: |
      cd emacs-universal-sidecar
      emacs --batch -l build/init.el -L . -f batch-byte-compile universal-sidecar-elfeed-related.el
  - build-ebib-sidecar: |
      cd emacs-universal-sidecar
      emacs --batch -l build/init.el -L . -f batch-byte-compile ebib-sidecar.el
  - build-org-cite-sidecar: |
      cd emacs-universal-sidecar
      emacs --batch -l build/init.el -L . -f batch-byte-compile org-cite-sidecar.el
